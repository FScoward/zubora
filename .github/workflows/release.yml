name: Build and Release

on:
  push:
    tags:
      - 'v*'

env:
  APP_NAME: Zubora

jobs:
  build:
    runs-on: macos-14  # Apple Silicon (M1/M2) + Rosetta for x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.0"

      # === Universal Binary Build ===
      - name: Build Release (arm64)
        run: swift build -c release --arch arm64

      - name: Build Release (x86_64)
        run: swift build -c release --arch x86_64

      - name: Create Universal Binary
        run: |
          mkdir -p .build/universal
          lipo -create \
            .build/arm64-apple-macosx/release/${{ env.APP_NAME }} \
            .build/x86_64-apple-macosx/release/${{ env.APP_NAME }} \
            -output .build/universal/${{ env.APP_NAME }}
          mkdir -p .build/release
          cp .build/universal/${{ env.APP_NAME }} .build/release/

      # === Package App Bundle ===
      - name: Package App
        run: |
          chmod +x package_app.sh
          ./package_app.sh

      # === Upload ===
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ github.ref_name }}
          path: ${{ env.APP_NAME }}.zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.APP_NAME }}.zip
          generate_release_notes: true
